# ì…ì‹¤ ì²´í¬ í•´ì£¼ì„¸ìš” !! ğŸ’Œ

# CORS Filter ì¶”ê°€í•˜ê¸°
- CORS(Cross-Origin Resources Sharing) : í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°€ êµì°¨ ì¶œì²˜ ì¬ìš”ì²­ì„ í—ˆìš©í• ì§€ ê±°ë¶€í• ì§€ë¥¼ ê²°ì •í•˜ê²Œ í•˜ëŠ” íŠ¹ì • í—¤ë”ë¥¼ ê°€ì§. 
- CORS filterëŠ” ë‹¤ë¥¸ ì¶œì²˜ì—ì„œ ìš”ì²­ì„ ë³´ë‚´ëŠ” í”„ë¡ íŠ¸ì—”ë“œì™€ì˜ í†µì‹ ì—ì„œ í•„ìš”í•©ë‹ˆë‹¤.
- í”„ë¡ íŠ¸ì—”ë“œ ìƒì—ì„œ íŠ¹ì • ìš”ì²­ì´ ë°±ì—”ë“œë¡œ ë„˜ì–´ê°€ê²Œ ë˜ëŠ” ê³¼ì •ì—ì„œ CORS í•„í„°ê°€ ìš”ì²­ì„ ì¤‘ê°„ì— í™•ì¸í•˜ì—¬, êµì°¨ ì¶œì²˜ë¡œ ì‹ë³„ë˜ë©´ ìš”ì²­ì— ì ì ˆí•œ í—¤ë”ë¥¼ ì¶”ê°€í•˜ì—¬ ì„œë¡œ í†µì‹ ì„ ì£¼ê³  ë°›ì„ ìˆ˜ ìˆë„ë¡ í—ˆìš©í•´ì¤ë‹ˆë‹¤.
- CorsConfigurationSource ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- í˜„ì¬ê¹Œì§€ì˜ ì˜ˆì œì—ì„œëŠ” ëª¨ë“  ì¶œì²˜ì˜ HTTP ë©”ì„œë“œì™€ í—¤ë”ë¥¼ í—ˆìš©í•˜ëŠ” ìƒíƒœì…ë‹ˆë‹¤.

1. SecurityConfig í´ë˜ìŠ¤ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.
ìˆ˜ì •ì „
```java
package com.example.cardatabase;

import com.example.cardatabase.service.UserDetailsServiceImpl;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
public class SecurityConfig {
    private final UserDetailsServiceImpl userDetailsService;
    private final AuthenticationFilter authenticationFilter;
    private final AuthEntryPoint exceptionHandler;

    public SecurityConfig(UserDetailsServiceImpl userDetailsService, AuthenticationFilter authenticationFilter, AuthEntryPoint exceptionHandler) {
        this.userDetailsService = userDetailsService;
        this.authenticationFilter = authenticationFilter;
        this.exceptionHandler = exceptionHandler;
    }

    public void configGlobal (AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService).passwordEncoder(new BCryptPasswordEncoder());
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf -> csrf.disable())
                .sessionManagement(sessionManagement ->
                        sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(authorizeHttpRequests ->
                        authorizeHttpRequests.requestMatchers(HttpMethod.POST, "/login").permitAll().anyRequest().authenticated())
                .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class)
                .exceptionHandling(exceptionHandling ->
                        exceptionHandling.authenticationEntryPoint(exceptionHandler));
        return http.build();
    }
}
```
cors ê´€ë ¨ ì¶”ê°€
```java
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        CorsConfiguration config = new CorsConfiguration();
        config.setAllowedOrigins(Arrays.asList("*"));
        config.setAllowedMethods(Arrays.asList("*"));
        config.setAllowedHeaders(Arrays.asList("*"));

        config.setAllowCredentials(false);
        config.applyPermitDefaultValues();

        source.registerCorsConfiguration("/**", config);
        return source;
    }
```
// íŠ¹ì • Originë§Œì„ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜í•˜ë ¤ë©´
`config.setAllowOrigins(Arrays.asList("http://localhost:5173", "http://localhost:3000"))`
ê³¼ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì–´ì°¨í”¼ 5173ì¼ê±°ë‹ˆê¹Œ í—·ê°ˆë¦¬ë©´ ctrl + fë¡œ 5173 ê²€ìƒ‰í•´ë‘ì„¸ìš”.
2. SecurityConfigë¥¼ ìˆ˜ì •í–ˆìœ¼ë‹ˆ filterChain ê´€ë ¨ methodë„ ìˆ˜ì •í•´ì•¼í•©ë‹ˆë‹¤.

```java
import static org.springframework.security.config.Customizer.withDefaults;


    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf -> csrf.disable())
                .cors(withDefaults())                     // ì—¬ê¸° ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. ê·¼ë° static ë©”ì„œë“œ ì¶”ê°€í•˜ëŠ” importë¬¸ë„ ì¶”ê°€ë¨.
                .sessionManagement(sessionManagement ->
                        sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(authorizeHttpRequests ->
                        authorizeHttpRequests.requestMatchers(HttpMethod.POST, "/login").permitAll().anyRequest().authenticated())
                .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class)
                .exceptionHandling(exceptionHandling ->
                        exceptionHandling.authenticationEntryPoint(exceptionHandler));
        return http.build();
    }
```

# Role-Based Protection
- Spring SecurityëŠ” ì—­í• ì„ ì´ìš©í•˜ì—¬ ì„¸ë¶„í™”ëœ ì—­í•  ê¸°ë°˜ ë³´ì•ˆì„ ì •ì˜í•  ìˆ˜ ìˆìœ¼ë©°, ì‚¬ìš©ìëŠ” í•˜ë‚˜ ë˜ëŠ” ì—¬ëŸ¬ ì—­í• ì— í• ë‹¹ë˜ì–´ì§ˆ ìˆ˜ ìˆë‹¤. ì—­í• ì€ í”íˆ ADMIN / MANAGER / USERì™€ ê°™ì€ ê³„ì¸µ êµ¬ì¡°ë¥¼ ê°€ì§€ê²Œ ë˜ëŠ”ë° USERê°€ í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ì¼ì€ MANAGERê°€ ë‹¤ í•  ìˆ˜ ìˆìœ¼ë©´ì„œ MANAGERëŠ” USERë³´ë‹¤ ë” ë§ì€ ì ‘ê·¼ ê¶Œí•œì„ ê°€ì§€ê³ , ADMINì€ MANAGERê°€ í•  ìˆ˜ ìˆëŠ”ê±¸ ë˜ ë‹¤ í•  ìˆ˜ ìˆìœ¼ë©´ì„œ ì§€ë§Œ í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ì ‘ê·¼ ê¶Œí•œì„ ê°–ëŠ” ë“±ìœ¼ë¡œ ìƒê°í•˜ì‹œë©´ ë˜ê² ìŠµë‹ˆë‹¤.

SecurityConfig í´ë˜ìŠ¤ì˜ ìš”ì²­ ìˆ˜ì¤€ì—ì„œ ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´í•˜ì˜ ì˜ˆì œ ì½”ë“œì—ì„œëŠ” ì ‘ê·¼ì„ ìœ„í•œ íŠ¹ì • ì—­í• ì´ í•„ìš”í•œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì •ì˜í• ê²ë‹ˆë‹¤. `/admin/**` ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼í•˜ë ¤ë©´ ADMIN ì—­í• ì´ í•„ìš”í•˜ê³ , `/user/**` ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼í•˜ë ¤ë©´ USER ì—­í• ì´ í•„ìš”í•œ ë“±ì´ ë˜ê² ìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì§€ì •ëœ ì—­í• ì„ ê°€ì§€ê³  ìˆìœ¼ë©´ trueë¥¼ ë°˜í™˜í•˜ëŠ” Spring Security hasRole() ë©”ì„œë“œë¥¼ ì´ìš©í•©ë‹ˆë‹¤.


Role-Based Protection ì ìš© filterChain ì˜ˆì‹œ(ì˜ˆì œ í”„ë¡œì íŠ¸ì—ëŠ” ë„ì…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
```java
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf -> csrf.disable())
                .cors(withDefaults())
                .sessionManagement(sessionManagement ->
                        sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(authorizeHttpRequests ->
                  authorizeHttpRequests.requestMatchers("/admin/**").hasRole("ADMIN").requestMatchers("/user/**").hasRole("USER").anyRequest().authenticated())
                .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class)
                .exceptionHandling(exceptionHandling ->
                        exceptionHandling.authenticationEntryPoint(exceptionHandler));
        return http.build();
    }
```

Spring SecurityëŠ” Method ìˆ˜ì¤€ì˜ ë³´ì•ˆì„ ì ìš©í•˜ëŠ” ë° ì´ìš©ë˜ëŠ” `@PreAuthorize, @PostAuthorize, @PreFilter, @PostFilter, @Secured` ì• ë„ˆí…Œì´ì…˜ë“¤ì´ ìˆìŠµë‹ˆë‹¤. ë©”ì„œë“œ ìˆ˜ì¤€ ë³´ì•ˆì€ defaultë¡œ spring-boot-starter-securityì—ì„œ ì´ìš©í•˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ìŠ¤í”„ë§ êµ¬ì„± í´ë˜ìŠ¤(ìµœìƒìœ„-ì €í¬ ê¸°ì¤€ìœ¼ë¡œ CarDatabaseApplication)ì—ì„œ `@EnableMethodSecurity` ì• ë„ˆí…Œì´ì…˜ì„ ì´ìš©í•˜ì—¬ í™œì„±í™”í•´ì•¼í•˜ëŠ”ë°...
ì˜ˆì‹œë¡œ ë‚¨ê²¨ë‘ì§€ëŠ” ì•Šê² ìŠµë‹ˆë‹¤.

# BackEnd Tests
í˜„ì¬ê¹Œì§€ì˜ ì½”ë“œ ì‘ì„± íŒŒíŠ¸ë¥¼ ì „ë¶€ ê¹ƒí—ˆë¸Œì— ì˜¬ë ¤ë‘ê² ìŠµë‹ˆë‹¤.
git add .
git commit -m "feat: backend protection finished"
git push